# nestedness:----------------------

# we need a community matrix, including presence/absence of species (1 = species present, 0 = absent)
#so, we should create presence/absence = 1/0 :

#library:
install.packages("reshape2")
library(reshape2)

## add presence column
data$presence <- 1

## all species
community_matrix <- dcast(
  data,
  island ~ species,
  value.var = "presence",
  fun.aggregate = length,
  fill = 0
)

## Convert to matrix
rownames(community_matrix) <- community_matrix$island
community_matrix <- as.matrix(community_matrix[, -1])


# Calculate nestedness for all species:

install.packages("vegan")
library(vegan)

nested_all <- nestednodf(community_matrix)
nested_all
## NODF : 53.12      overall nestedness index (% scale, 0–100)
## our mammal community shows moderate nestedness (NODF ≈ 53)


# Repeat nestedness for Natives and aliens:

# 1. Natives:
### Filter your dataset by status:
Native_data <- subset(data, status == "Native")
Native_matrix <- dcast(Native_data, island ~ species, value.var = "presence", fun.aggregate = length, fill = 0)

rownames(Native_matrix) <- Native_matrix$island
Native_matrix <- as.matrix(Native_matrix[, -1])
nested_Native <- nestednodf(Native_matrix)
nested_Native

# 2. Aliens:
alien_data <-
  subset(data, status == "Alien")
alien_matrix <- dcast(alien_data, island ~ species, value.var = "presence", fun.aggregate = length, fill = 0)
rownames(alien_matrix) <- alien_matrix$island
alien_matrix <- as.matrix(alien_matrix[, -1])
nested_alien <- nestednodf(alien_matrix)
nested_alien

## comparision nestedness:
## Natives > Aliens in nestedness (54 vs 47): Native communities are more structured by area/biogeography: small islands are subsets of larger islands.
## Nestedness highlights that Natives are shaped by “natural” biogeographic filters, while aliens are shaped by “anthropogenic” processes.
## Aliens have lower fill (10% vs 18%):  Fewer alien species occur across the islands, and they are patchier in distribution.


# significance test (permutation/randomization):

set.seed(123) 
test_all <- oecosimu(community_matrix, nestednodf, "swap", nsimul = 1000)
summary(test_all)

set.seed(123)
test_Native <- oecosimu(Native_matrix, nestednodf, "swap", nsimul = 1000)
summary(test_Native)

set.seed(123)
test_alien <- oecosimu(alien_matrix, nestednodf, "swap", nsimul = 1000)
summary(test_alien)

test_all
test_Native
test_alien

