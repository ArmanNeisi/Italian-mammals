# nestedness:----------------------

# libraries:
install.packages("readxl")
library(readxl)
library(ggplot2)
library(dplyr)

#import database:
data <- read_excel("F:/arman/bologna/me/thesis/checlists/final islands.xlsx")
View(data)


# we need a community matrix, including presence/absence of species (1 = species present, 0 = absent)
#so, we should create presence/absence = 1/0 :

#library:
install.packages("reshape2")
library(reshape2)

## add presence column
data$presence <- 1

## all species
community_matrix <- dcast(
  data,
  island ~ species,
  value.var = "presence",
  fun.aggregate = length,
  fill = 0
)

## Convert to matrix
rownames(community_matrix) <- community_matrix$island
community_matrix <- as.matrix(community_matrix[, -1])


# Calculate nestedness for all species:

install.packages("vegan")
library(vegan)

nested_all <- nestednodf(community_matrix)
nested_all
## N columns  : 59.6117   ##How much species’ distributions across islands are nested.
## N rows     : 51.99205    ## How much the island communities themselves form subsets of one another.
## NODF       : 53.79447    ## overall nestedness index (% scale, 0–100); our mammal community shows moderate nestedness (NODF ≈ 59.6), meaning the system has some order (nestedness), but also randomness, 


# Repeat nestedness for Natives and aliens:

# 1. Natives:
## Filter your dataset by status:

Native_data <- subset(data, status == "Native")
Native_matrix <- dcast(Native_data, island ~ species, value.var = "presence", fun.aggregate = length, fill = 0)
rownames(Native_matrix) <- Native_matrix$island
Native_matrix <- as.matrix(Native_matrix[, -1])
nested_Native <- nestednodf(Native_matrix)
nested_Native

# 2. Aliens:
alien_data <-
  subset(data, status == "Alien")
alien_matrix <- dcast(alien_data, island ~ species, value.var = "presence", fun.aggregate = length, fill = 0)
rownames(alien_matrix) <- alien_matrix$island
alien_matrix <- as.matrix(alien_matrix[, -1])
nested_alien <- nestednodf(alien_matrix)
nested_alien

## comparision nestedness:
## Natives > Aliens in nestedness(NODF) (54 vs 46): Native communities are more structured by area/biogeography: small islands are subsets of larger islands.
## Nestedness highlights that Natives are shaped by “natural” biogeographic filters, while aliens are shaped by “anthropogenic” processes.
## Aliens have lower fill (10% vs 18%):  Fewer alien species occur across the islands, and they are patchier in distribution.
# N columns for native > for alien: species distributions are fairly nested. aliens are not as consistently nested.
# N rows for natives > for alien: islands themselves also follow a nested order (species-poor islands ≈ subsets of species-rich islands). alien assemblages across islands are somewhat nested, but weaker than natives.


# significance test (permutation/randomization):

set.seed(123) 
test_all <- oecosimu(community_matrix, nestednodf, "swap", nsimul = 1000)
summary(test_all)

set.seed(123)
test_Native <- oecosimu(Native_matrix, nestednodf, "swap", nsimul = 1000)
summary(test_Native)

set.seed(123)
test_alien <- oecosimu(alien_matrix, nestednodf, "swap", nsimul = 1000)
summary(test_alien)

test_all
test_Native
test_alien

## All p = 0.245 → not significant             ##The total mammal fauna across islands is not significantly more nested than what you’d expect if species were randomly shuffled
## Natives p = 0.009 (significant)     ## Native mammals are significantly more nested than random.
## Alien p = 0.013 (significant)           ## Alien mammals are also significantly nested, though at a lower absolute level than natives.
## Negative SES values mean the observed nestedness is lower than expected under the null. But because p-values are significant, that difference is not due to chance.

